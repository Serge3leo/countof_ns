---
# vim:set sw=2 ts=8 et fileencoding=utf8:
# SPDX-License-Identifier: BSD-2-Clause
# SPDX-FileCopyrightText: 2025 Сергей Леонтьев (leo@sai.msu.ru)
#
# This starter workflow is for a CMake project running on multiple platforms.
# There is a different starter workflow if you just want a single platform.
# See:
# https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml

name: CMake on multiple platforms

on:  # yamllint disable-line rule:truthy
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all
      # matrix combinations. Consider changing this to true when your workflow
      # is stable.

      fail-fast: true

      # Set up a matrix to run the following 4 configurations:
      #
      # 1. <Latest MSVC compiler toolchain on the default runner image,
      # Windows, Release, default generator>
      #
      # 2. <Latest GCC compiler toolchain on the default runner image, Linux,
      # Release, default generator>
      #
      # 3. <Latest Clang compiler toolchain on the default runner image, Linux,
      # Release, default generator>
      #
      # 4. <oneAPI 2025.1, Linux, Release, default generator>
      #
      # 5. <LCC MCST Elbrus e2k, Linux, Release, default generator>
      #
      # To add more build types (Release, Debug, RelWithDebInfo, etc.)
      # customize the build_type list.

      matrix:
        c_compiler: [gcc, clang, cl, icx, lcc]
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
        include:
          - c_compiler: cl
            cpp_compiler: cl
            os: windows-latest
            platform: "win32"
          - c_compiler: gcc
            cpp_compiler: g++
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: clang
            cpp_compiler: clang++
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: icx
            cpp_compiler: icpx
            oneapi: 2025.1
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: lcc
            cpp_compiler: l++
            lcc: "1.27.23.e2k-v5.5.10"
            platform: "e2k"
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: windows-latest
            c_compiler: icx
          - os: windows-latest
            c_compiler: lcc
          - os: ubuntu-latest
            c_compiler: cl

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Cache install oneAPI
        if: ${{ matrix.c_compiler == 'icx' }}
        id: cache-install
        uses: actions/cache@v4
        with:
          path: |
            /opt/intel/oneapi
          key: oneapi-${{ matrix.oneapi }}-apt

      - name: Non-cache install oneAPI
        if: ${{ matrix.c_compiler == 'icx' }}
        run: |
          if [ "${{ steps.cache-install.outputs.cache-hit }}" != "true" ]; then
            bash .github/workflows/oneapi_setup_apt_repo_linux.sh
            sudo apt install --no-install-recommends \
                 intel-oneapi-compiler-dpcpp-cpp-${{ matrix.oneapi }}
          fi

      - name: Setup Intel oneAPI environment
        if: ${{ matrix.c_compiler == 'icx' }}
        run: |
          source /opt/intel/oneapi/setvars.sh
          printenv >> $GITHUB_ENV

      - name: Cache install LCC MCST Elbrus e2k
        if: ${{ matrix.c_compiler == 'lcc' }}
        id: cache-lcc
        uses: actions/cache@v4
        with:
          path: |
            /opt/mcst
            /usr/local/bin/e2k
            /usr/local/bin/qemu-e2k
            /usr/local/bin/lcc
            /usr/local/bin/l++
          key: cache-${{ matrix.llc }}-mrognor

      - name: Non-cache install LCC MCST Elbrus e2k
        if: ${{ matrix.c_compiler == 'lcc' && steps.cache-lcc.outputs.cache-hit != 'true' }}  # yamllint disable-line rule:line-length
        uses: mrognor/lcc-env-action@0.1.1

      - name: Set reusable strings
        # Turn repeated input strings (such as the build output directory) into
        # step outputs. These step outputs can be used throughout the workflow
        # file.

        id: strings
        shell: bash
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" \
              >> "$GITHUB_OUTPUT"

      - name: Install python module
        working-directory: ${{ github.workspace }}/tests/check_logs
        run: |
          python -c "import sys; print(sys.version); print(sys.executable)"
          python -m pip install --upgrade pip
          python -m pip install junitparser yamllint
          python post_check.py --selftest

      - name: Lint
        run: |
          python -m yamllint --list-file .
          python -m yamllint .

      - name: Linux short_example
        if: ${{ matrix.platform == 'linux' }}
        run: |
          ./examples-build.sh -c ${{ matrix.c_compiler }}

      - name: Linux FetchContent example
        if: ${{ matrix.platform == 'linux' }}
        working-directory: ${{ github.workspace }}/examples/cmake_fetch_content
        run: |
          ./shortest-build.sh -c ${{ matrix.c_compiler }}

      - name: Linux long_example
        if: ${{ matrix.platform == 'linux' }}
        run: |
          ./examples-build.sh -c ${{ matrix.c_compiler }} -- \
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_EXAMPLES=ON"

      - name: Linux tests
        if: ${{ matrix.platform == 'linux' }}
        run: |
          ./examples-build.sh -c ${{ matrix.c_compiler }} -- \
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_TESTS=ON"

      - name: Linux comparisons
        if: ${{ matrix.platform == 'linux' }}
        run: |
          ./examples-build.sh -c ${{ matrix.c_compiler }} -- \
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_COMPARISONS=ON" \
              "-DCOUNTOF_NS_DOCTESTS=ON"

      - name: E2k short_example
        if: ${{ matrix.platform == 'e2k' }}
        run: |
          ./examples/LCC_MCST_Elbrus_e2k-build.sh

      - name: E2k long_example
        if: ${{ matrix.platform == 'e2k' }}
        run: |
          ./examples/LCC_MCST_Elbrus_e2k-build.sh \
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_EXAMPLES=ON"

      - name: E2k tests
        if: ${{ matrix.platform == 'e2k' }}
        run: |
          ./examples/LCC_MCST_Elbrus_e2k-build.sh \
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_TESTS=ON"

      - name: E2k comparisons
        if: ${{ matrix.platform == 'e2k' }}
        run: |
          ./examples/LCC_MCST_Elbrus_e2k-build.sh \
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_COMPARISONS=ON" \
              "-DCOUNTOF_NS_DOCTESTS=ON"

      - name: Windows short_example
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          examples-build.bat

      - name: Windows FetchContent example
        working-directory: ${{ github.workspace }}/examples/cmake_fetch_content
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          shortest-build.bat

      - name: Windows long_example
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          examples-build.bat -- ^
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_EXAMPLES=ON"

      - name: Windows tests
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          examples-build.bat -- ^
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_TESTS=ON"

      - name: Windows comparisons
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          examples-build.bat -- ^
              "-DCOUNTOF_NS_SHORT_EXAMPLE=OFF" "-DCOUNTOF_NS_COMPARISONS=ON" ^
              "-DCOUNTOF_NS_DOCTESTS=ON"

      - name: Exclude unused files from cache
        if: ${{ matrix.c_compiler == 'icx' }}
        run: |
          if [ "${{ steps.cache-install.outputs.cache-hit }}" != "true" ]; then
            bash .github/workflows/oneapi_cache_exclude_linux.sh
          fi
