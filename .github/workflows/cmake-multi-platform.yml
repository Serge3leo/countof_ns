---
# vim:set sw=2 ts=8 et fileencoding=utf8:
# SPDX-License-Identifier: BSD-2-Clause
# SPDX-FileCopyrightText: 2025 Сергей Леонтьев (leo@sai.msu.ru)
#
# This starter workflow is for a CMake project running on multiple platforms.
# There is a different starter workflow if you just want a single platform.
# See:
# https://github.com/actions/starter-workflows/blob/main/ci/cmake-single-platform.yml

name: CMake on multiple platforms

on:  # yamllint disable-line rule:truthy
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      # Set fail-fast to false to ensure that feedback is delivered for all
      # matrix combinations. Consider changing this to true when your workflow
      # is stable.

      fail-fast: false

      # Set up a matrix to run the following 4 configurations:
      #
      # 1. <Latest MSVC compiler toolchain on the default runner image,
      # Windows, Release, default generator>
      #
      # 2. <Latest GCC compiler toolchain on the default runner image, Linux,
      # Release, default generator>
      #
      # 3. <Latest Clang compiler toolchain on the default runner image, Linux,
      # Release, default generator>
      #
      # 4. <oneAPI 2025.1, Linux, Release, default generator>
      #
      # To add more build types (Release, Debug, RelWithDebInfo, etc.)
      # customize the build_type list.

      matrix:
        c_compiler: [gcc, clang, cl, icx]
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]
        include:
          - c_compiler: cl
            cpp_compiler: cl
            os: windows-latest
            platform: "win32"
          - c_compiler: gcc
            cpp_compiler: g++
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: clang
            cpp_compiler: clang++
            os: ubuntu-latest
            platform: "linux"
          - c_compiler: icx
            cpp_compiler: icpx
            oneapi: 2025.1
            os: ubuntu-latest
            platform: "linux"
        exclude:
          - os: windows-latest
            c_compiler: gcc
          - os: windows-latest
            c_compiler: clang
          - os: windows-latest
            c_compiler: icx
          - os: ubuntu-latest
            c_compiler: cl

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Cache install oneAPI
        if: ${{ matrix.c_compiler == 'icx' }}
        id: cache-install
        uses: actions/cache@v4
        with:
          path: |
            /opt/intel/oneapi
          key: oneapi-${{ matrix.oneapi }}-apt

      - name: Non-cache install oneAPI
        if: ${{ (matrix.c_compiler == 'icx') && (steps.cache-install.outputs.cache-hit != 'true') }}  # yamllint disable-line rule:line-length
        timeout-minutes: 5
        run: |
          bash .github/workflows/oneapi_setup_apt_repo_linux.sh
          sudo apt install --no-install-recommends \
               intel-oneapi-compiler-dpcpp-cpp-${{ matrix.oneapi }}

      - name: Setup Intel oneAPI environment
        run: |
          source /opt/intel/oneapi/setvars.sh
          printenv >> $GITHUB_ENV

      - name: Set reusable strings
        # Turn repeated input strings (such as the build output directory) into
        # step outputs. These step outputs can be used throughout the workflow
        # file.

        id: strings
        shell: bash
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" \
              >> "$GITHUB_OUTPUT"

      - name: Install python module
        working-directory: ${{ github.workspace }}/tests/check_logs
        run: |
          python -c "import sys; print(sys.version); print(sys.executable)"
          python -m pip install --upgrade pip
          python -m pip install junitparser yamllint
          python post_check.py --selftest

      - name: Lint
        run: |
          python -m yamllint --list-file .
          python -m yamllint .

      - name: Unix examples-build.sh
        if: ${{ matrix.platform != 'win32' }}
        run: |
          ./examples-build.sh -c ${{ matrix.c_compiler }}

      - name: Windows examples-build.bat
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          examples-build.bat

      - name: Unix FetchContent example
        if: ${{ matrix.platform != 'win32' }}
        working-directory: ${{ github.workspace }}/examples/cmake_fetch_content
        run: |
          ./shortest-build.sh -c ${{ matrix.c_compiler }}

      - name: Windows examples-build.bat
        working-directory: ${{ github.workspace }}/examples/cmake_fetch_content
        if: ${{ matrix.platform == 'win32' }}
        shell: cmd
        run: |
          shortest-build.bat

      - name: Exclude unused files from cache
        if: steps.cache-install.outputs.cache-hit != 'true'
        run: >
          bash .github/workflows/oneapi_cache_exclude_linux.sh
